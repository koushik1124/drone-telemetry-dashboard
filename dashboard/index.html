<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Drone Telemetry Dashboard</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; }
  h1 { color: #333; padding: 15px; margin: 0; background: #f4f4f4; }
  .container { display: flex; height: calc(100vh - 60px); }
  #map { flex: 2; height: 100%; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 6px; border: 1px solid #ccc; text-align: center; font-size: 14px; }
  th { background: #f4f4f4; }
  #table-container { flex: 1; overflow-y: auto; max-height: 100%; }
</style>
</head>
<body>

<h1>Drone Telemetry Dashboard</h1>

<div class="container">
  <div id="map"></div>
  <div id="table-container">
    <table>
      <thead>
        <tr>
          <th>Drone ID</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Altitude (m)</th>
          <th>Speed (km/h)</th>
          <th>Battery (%)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="telemetry-table"></tbody>
    </table>
  </div>
</div>

<script>
  const socket = io("http://localhost:5000");

  // Initialize map
  const map = L.map('map').setView([17.3850, 78.4867], 12); // Default: Hyderabad
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // Store drone markers
  const droneMarkers = {};

  socket.on("connect", () => {
    console.log("âœ… Connected to WebSocket server");
  });

  socket.on("telemetry", (data) => {
    console.log("ðŸ“¡ Live data:", data);

    // Update table
    const table = document.getElementById("telemetry-table");
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${data.droneId}</td>
      <td>${data.latitude.toFixed(4)}</td>
      <td>${data.longitude.toFixed(4)}</td>
      <td>${data.altitude.toFixed(1)}</td>
      <td>${data.speed.toFixed(1)}</td>
      <td>${data.battery.toFixed(0)}</td>
      <td>${data.status}</td>
    `;

    table.insertBefore(row, table.firstChild);
    if (table.rows.length > 10) table.deleteRow(10);

    // Update marker on map
    if (droneMarkers[data.droneId]) {
      droneMarkers[data.droneId].setLatLng([data.latitude, data.longitude]);
      droneMarkers[data.droneId].bindPopup(
        `<b>${data.droneId}</b><br>Battery: ${data.battery.toFixed(0)}%<br>Status: ${data.status}`
      );
    } else {
      const marker = L.marker([data.latitude, data.longitude])
        .addTo(map)
        .bindPopup(
          `<b>${data.droneId}</b><br>Battery: ${data.battery.toFixed(0)}%<br>Status: ${data.status}`
        );
      droneMarkers[data.droneId] = marker;
    }
  });
</script>

</body>
</html>
